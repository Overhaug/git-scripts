#!/bin/zsh

BLUE="\e[0;34m"
LBLUE="\e[1;34m"
RED="\e[0;31m"
LRED="\e[1;31m"
GREEN="\e[0;32m"
LGREEN="\e[1;32m"
DGREEN="\e[1;30m"
YELLOW="\e[1;33m"
PURPLE="\e[0;35m"
LPURPLE="\e[1;35m"
CYAN="\e[0;36m"
LCYAN="\e[1;36m"
LGRAY="\e[0;37m"
WHITE="\e[1;37m"
BLACK="\e[0;30m"
NC="\e[0m"

declare -A colors
colors=(
  [yellow]=$YELLOW
  [blue]=$BLUE
  [lightblue]=$LBLUE
  [red]=$RED
  [lightred]=$LRED
  [green]=$GREEN
  [lightgreen]=$LGREEN
  [darkgreen]=$DGREEN
  [purple]=$PURPLE
  [lightpurple]=$LPURPLE
  [cyan]=$CYAN
  [lightcyan]=$LCYAN
  [lightgrey]=$LGRAY
  [white]=$WHITE
  [white]=$BLACK
  [nocolor]=$NC
)

gitAuthor="$(eval "git config --global --get user.name")"

typeset -A config
config=(
  [repoColor]="lightblue"
  [commitColor]="nocolor"
  [resultColor]="yellow"
  [repoSepColor]="nocolor"
  [user]="$gitAuthor"
)

scriptDir=$(dirname "$0")
while read -r line; do
  if echo "$line" | grep -F = &>/dev/null; then
    varname=$(echo "$line" | cut -d '=' -f 1)
    config[$varname]=$(echo "$line" | cut -d '=' -f 2-)
  fi
done <"$scriptDir"/gall.conf

HELP="${colors[nocolor]}help
Commands:
  status - checks status of all repositories in current directory
  log - prints log of all repositories in current directory
    flags:
     --since - date on which to find commits since, format YYYY-MM-DD
     --until - date on which to find commits until, format YYYY-MM-DD
     --self - only find commits by you (filtered by user.name in global git config)
     --author - only find commits by specified author (username)
   cmd - run any git command in all repositories in current directory
   edit config - edit script config

You can set custom colors in gall.conf:
  repoColor - Repository heading color
  commitColor - Commit line color
  resultColor - Result line color
  repoSepColor - Repository line separator color

  Available colors:
    ${colors[nocolor]}Reds:
      - ${colors[red]}red
      - ${colors[lightred]}lightred
    ${colors[nocolor]}Blues:
      - ${colors[blue]}blue
      - ${colors[lightblue]}lightblue
    ${colors[nocolor]}Greens:
      - ${colors[green]}green
      - ${colors[lightgreen]}lightgreen
      - ${colors[darkgreen]}darkgreen
    ${colors[nocolor]}Cyans:
      - ${colors[cyan]}cyan
      - ${colors[lightcyan]}lightcyan
    ${colors[nocolor]}Purples:
      - ${colors[purple]}purple
      - ${colors[lightpurple]}lightpurple
    ${colors[nocolor]}Yellows:
      - ${colors[yellow]}yellow
    ${colors[nocolor]}Miscellaneous:
      - nocolor (sets back to default)
      - white
      - black
"

validateDate() {
  IFS=\= read -r left right <<<"$1"
  if [[ $right =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    validDate=$1
    return 0
  else
    echo "Date $right is in an invalid format (not YYYY-MM-DD)"
    return 1
  fi
}

splitAndValidateArgOnEq() {
  IFS=\= read -r left right <<<"$1"
  if [[ $right != "" ]] && [[ $left != "" ]]; then
    return 0
  else
    return 1
  fi
}

separator() {
  printf "\n${colors[${config[repoSepColor]}]}"
  printf %"$COLUMNS"s | tr " " "-"
}

printRepoPath() {
  printf "${colors[${config[repoColor]}]}"
  printf "$pure\n$NC"
}

args=("$@")
if [[ ${args[1]} == "status" ]]; then
  gitCommand="status"
  type="status"
elif [[ ${args[1]} == "log" ]]; then
  gitCommand="log --graph --pretty=format:""'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
  type="log"
  unrecognizedArgs=()
  for arg in ${args}; do
    if [[ $arg == "--on"* ]]; then
      if validateDate "$arg"; then
        gitCommand="$gitCommand --since='$right 00:00' --until='$right 23:59'"
      else
        exit
      fi
    elif [[ $arg == "--since"* ]]; then
      if validateDate "$arg"; then
        gitCommand="$gitCommand $validDate 00:00"
      else
        exit
      fi
    elif [[ $arg == "--until"* ]]; then
      if validateDate "$arg"; then
        gitCommand="$gitCommand $validDate 23:59"
      else
        exit
      fi
    elif [[ $arg == "--author"* ]]; then
      splitAndValidateArgOnEq "$arg"
      gitCommand="$gitCommand --author='$right'"
    elif [[ $arg == "self" ]]; then
      filterByAuthor="true"
      gitCommand="$gitCommand --author='${config[user]}"
    elif [[ $arg != "$type" ]]; then
      unrecognizedArgs+=("$arg")
    fi
  done
elif [[ ${args[1]} == "cmd" ]]; then
  type="cmd"
  echo -n "Command: git "
  read answer
  gitCommand=$answer
  cmdType=$answer

  echo -n "Sure? (y/n) "
  read -r answer2
  if [[ $answer2 == "n" ]]; then
    exit
  fi
elif [[ ${args[1]} == "edit" ]]; then
  if [[ ${args[2]} == "config" ]]; then
    eval "vim ${scriptDir}/gall.conf"
    exit
  fi
elif [[ ${args[1]} == "view" ]]; then
  if [[ ${args[2]} == "config" ]]; then
    eval "cat ${scriptDir}/gall.conf"
    exit
  fi
else
  echo -e "$HELP"
  exit
fi

root=$PWD
repos=0
numReposMatched=0
numCommits=0
numCommitsByAuthor=0
find . -type d \( -path "*/node_modules/*" -o -path "*/.idea/*" -o -path "*/.vscode/*" \) -prune -false -o -name '*.git' | while read -r dir; do
  if [[ $dir == *"/.git" ]]; then
    ((repos++))
    # todo combine replaces
    pure="${dir//\/.git/}"
    pure="${pure//./}"

    eval "cd $root/$pure"
    git="$(eval "git $gitCommand")"
    if [[ $type == "status" ]]; then
      if [[ $git == *"Your branch is ahead"* ]]; then # todo a faster way of matching?
        ((numReposMatched++))
        printRepoPath
        printf "${colors[${config[commitColor]}]}$git" | sed -n 1,2p
        separator
      fi
    elif [[ $type == "log" ]] && [[ $git == *" "* ]]; then
      printRepoPath
      ((numReposMatched++))
      printf "${colors[${config[commitColor]}]}$git"

      while read -r line; do
        if [[ $filterByAuthor == "true" ]]; then
          ((numCommitsByAuthor++))
          ((numCommits++))
        else
          ((numCommits++))
        fi
      done <<<"$git"

      separator
    elif [[ $type == "cmd" ]]; then
      if [[ $git == *" "* ]]; then
        printRepoPath
        ((numReposMatched++))
        printf "${colors[${config[commitColor]}]}$git"
        separator
      fi
    fi
  fi
done

if [[ $type == "status" ]]; then
  echo "${colors[${config[resultColor]}]}> Checked $repos repositories, $numReposMatched are ahead"
elif [[ $type == "log" ]]; then
  if [[ $filterByAuthor == "true" ]]; then
    echo "${colors[${config[resultColor]}]}> Found $numCommitsByAuthor commits by you in $numReposMatched/$repos repos"
  else
    echo "${colors[${config[resultColor]}]}> Found $numCommits commits in $numReposMatched repos"
  fi
fi

if ((${#unrecognizedArgs[@]} != 0)); then
  echo "${colors[${config[resultColor]}]}> Ignored arguments: $unrecognizedArgs"
fi
